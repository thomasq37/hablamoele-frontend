<!-- Menu dynamique -->
<app-menu [menuItems]="menuItems"></app-menu>

<section class="ajouter-recursos">
  <div class="container">
    <div class="ajouter-recursos-container">

      <h1>Añadir un recurso</h1>

      <form [formGroup]="recursosForm" (ngSubmit)="ajouterRecursos()">

        <!-- Banner PNG -->
        <div class="form-field">
          <label for="banner">Banner (PNG) *:</label>
          <input
            #bannerInput
            type="file"
            id="banner"
            accept="image/png"
            (change)="onBannerChange($event)"
            required
          />
          <div class="file-info" *ngIf="bannerFileName">
            <span class="file-name">{{ bannerFileName }}</span>
            <button type="button" class="btn-remove" (click)="supprimerBanner()">×</button>
          </div>
        </div>

        <!-- Título -->
        <div class="form-field">
          <label for="titulo">Título *:</label>
          <input type="text" id="titulo" formControlName="titulo" required />
        </div>

        <!-- Descripción -->
        <div class="form-field">
          <label for="descripcion">Descripción *:</label>
          <textarea id="descripcion" formControlName="description" rows="5" required></textarea>
        </div>

        <!-- Etiquetas -->
        <div class="form-field">
          <label for="tags">Etiquetas (separadas por comas) *:</label>
          <input type="text" id="tags" formControlName="tags" placeholder="ejemplo: educación, recursos, PDF" required />
        </div>

        <!-- Categorías (multi) -->
        <div class="form-field">
          <label for="categorias">Categorías (opcional, multi):</label>

          <select
            id="categorias"
            class="select-multiple"
            formControlName="categoriasIds"
            multiple
            [disabled]="categoriasLoading || categoriasError !== ''"
          >
            <option
              *ngFor="let cat of categoriasDisponibles; trackBy: trackByCatId"
              [value]="cat.id"
            >
              {{ cat.nombre }}
            </option>
          </select>

          <div class="helper">
            <small *ngIf="categoriasLoading">Cargando categorías…</small>
            <small class="error" *ngIf="categoriasError">{{ categoriasError }}</small>
            <small *ngIf="!categoriasLoading && categoriasError === ''">
              Seleccionadas: {{ recursosForm.value.categoriasIds?.length || 0 }}
            </small>
          </div>
        </div>

        <!-- Niveles (multi) -->
        <div class="form-field">
          <label for="niveles">Niveles (opcional, multi):</label>

          <select
            id="niveles"
            class="select-multiple"
            formControlName="nivelesIds"
            multiple
            [disabled]="nivelesLoading || nivelesError !== ''"
          >
            <option
              *ngFor="let n of nivelesDisponibles; trackBy: trackByNivelId"
              [value]="n.id"
            >
              {{ n.nombre }}
            </option>
          </select>

          <div class="helper">
            <small *ngIf="nivelesLoading">Cargando niveles…</small>
            <small class="error" *ngIf="nivelesError">{{ nivelesError }}</small>
            <small *ngIf="!nivelesLoading && nivelesError === ''">
              Seleccionados: {{ recursosForm.value.nivelesIds?.length || 0 }}
            </small>
          </div>
        </div>
        <div class="form-field">
          <label for="nbInfografias">Número de infografías *:</label>
          <input
            type="number"
            id="nbInfografias"
            formControlName="nbInfografias"
            min="0"
            required
          />
          <div class="helper">
            <small *ngIf="recursosForm.get('nbInfografias')?.invalid && recursosForm.get('nbInfografias')?.touched">
              Campo obligatorio. Introduce un número válido.
            </small>
          </div>
        </div>

        <!-- Nombre de cuadernos de actividad -->
        <div class="form-field">
          <label for="nbCahiersActivite">Número de cuadernos de actividad *:</label>
          <input
            type="number"
            id="nbCahiersActivite"
            formControlName="nbCahiersActivite"
            min="0"
            required
          />
          <div class="helper">
            <small *ngIf="recursosForm.get('nbCahiersActivite')?.invalid && recursosForm.get('nbCahiersActivite')?.touched">
              Campo obligatorio. Introduce un número válido.
            </small>
          </div>
        </div>

        <!-- Infografías PDF -->
        <div class="form-field">
          <label for="infografias">Infografías (PDF) *:</label>
          <input
            #infografiasInput
            type="file"
            id="infografias"
            accept="application/pdf"
            multiple
            (change)="onInfografiasChange($event)"
            required
          />
          <small class="file-help">Puedes seleccionar múltiples archivos PDF</small>

          <!-- Lista de archivos seleccionados -->
          <div class="selected-files" *ngIf="infografiaFileNames.length > 0">
            <h4>Archivos seleccionados:</h4>
            <ul class="file-list">
              <li *ngFor="let fileName of infografiaFileNames; let i = index" class="file-item">
                <span class="file-name">{{ fileName }}</span>
                <button type="button" class="btn-remove-individual" (click)="supprimerInfografia(i)" [title]="'Eliminar ' + fileName">×</button>
              </li>
            </ul>
            <button type="button" class="btn-remove-all" (click)="supprimerInfografias()">
              Eliminar todos los archivos
            </button>
          </div>
        </div>

        <!-- Message d'erreur -->
        <div class="form-erreur-msg" *ngIf="errorMessage !== ''">
          {{ errorMessage }}
        </div>

        <!-- Actions formulaire -->
        <div class="form-actions">
          <app-action-btn
            [disabled]="!recursosForm.valid || !banner || infografiaFiles.length === 0"
            [estMisEnAvant]="true"
            type="submit"
            text="Añadir recurso"
          ></app-action-btn>
        </div>

      </form>
    </div>
  </div>
</section>
